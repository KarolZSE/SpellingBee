<!DOCTYPE html>
<html>
<head>
    <title>Spelling bee! üêù</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playwrite+AU+SA&display=swap" rel="stylesheet">
    <link type="image/png" sizes="16x16" rel="icon" href="favicon.png">
</head>
<style>
body {
    overflow: hidden;
    margin: 0;
    font-family: "Playwrite AU SA", serif;
    font-optical-sizing: auto;
    font-weight: 100;
    font-style: normal;
}

#back {
    position: absolute;
    background-color: rgb(0, 0, 0);
    top: 0;
    left: 0;
    z-index: -1;
}

line {
    stroke: rgb(255, 255, 255);
    stroke-width: 5;
}

span {
    opacity: 0;
    transition: opacity 0.5s;
}

#lspam {
    opacity: 1;
    font-size: smaller;
}

#menu {
    display: flex;
    align-self: center;
    justify-self: center;
    height: 86.74vh;
    width: 40%;
    border: 6.63vh solid;
    border-image: radial-gradient(circle, rgb(255, 255, 255), rgba(255, 255, 255, 0) 80%) 49% stretch;
    background-color: rgba(0, 0, 0, 0);
    z-index: 1;
}

#starting-menu-content {
    display: flex;
    background-color: rgb(255, 255, 255);
    height: 100%;
    width: 100%;
    flex-direction: column;
    align-items: center;
    text-align: center;
    overflow-y: auto;
}

#starting-menu-content p {
    padding-left: 5%;
    padding-right: 5%;
}

#menu-content {
    display: none;
    background-color: rgb(255, 255, 255);
    height: 100%;
    width: 100%;
    flex-direction: column;
    align-items: center;
    text-align: center;
    overflow-y: auto;
}

#bottom {
    display: flex;
    margin-top: auto;
    flex-direction: row;
    width: 100%;
    justify-content: space-between;
}

#bottom p { 
    padding-left: 5%;
    padding-right: 5%;
}

button {
    height: 40px;
    font-family: "Playwrite AU SA", serif;
    font-optical-sizing: auto;
    font-weight: 100;
    font-style: normal;
}

#SaveScore {
    margin-top: auto;
}

#name {
    position: relative;
    margin-left: 8px;
    top: -1vh;
    font-family: "Playwrite AU SA", serif;
    font-optical-sizing: auto;
    font-weight: 100;
    font-style: normal;
    text-align: center;
	height: 4.125vh;
	font-size: 0.67vw;
}

#parental-leaderboard {
    display: flex;
    align-items: flex-end;
    flex-direction: column;
    margin-top: -97.92vh;
    height: 95.84vh;
    }

#leaderboard {
    width: 20%;
    height: 100%;
    border: 3.604vh solid;
    border-image: radial-gradient(circle, rgb(255, 255, 255), rgba(255, 255, 255, 0) 80%) 49% stretch;
    background-color: rgba(0, 0, 0, 0);
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    }

#leaderboard-content {
    background-color: rgb(255, 255, 255);
    height: 100%;
    width: 100%;
    text-align: center;
    overflow-y: scroll;
    }

#leaderboard-content > p {
    display: flex;
    justify-content: space-between;
}
    
ol {
    padding: 0;
    margin: 10px;
}

li {
    display: flex;
    align-items: center; /* Align items vertically */
    justify-content: space-between; /* Distribute only spans */
    list-style: none; /* Remove default marker */
    counter-increment: list-counter; /* Increment custom counter */
}

ol {
    counter-reset: list-counter; /* Initialize custom counter */
}

li > span:first-child::before {
    content: counter(list-counter) "."; /* Add the number directly before the first span */
    color: black; /* Number color */
    margin-right: 0; /* No space between number and text */
}
</style>
<body>
    <svg id="back" height="100vh" width="100vw"></svg>
    <div id="menu">
        <div id="starting-menu-content">
            <h1>Hi<input type="text" id="name" placeholder="Type in your Username">! How are you?</input></h1>
            <h2>Welcome to the spelling bee! üêù</h2>
            <p> Your goal in this game is to correctly spell words. The browser will speak a 
                word to you, and your task is to type the word as quickly as you can.
                If you make 3 mistakes, the correct letter will reveal itself and turn red. 
                But don't worry‚Äîyou can still continue playing! To type, simply use your keyboard 
                in the browser. There's no need to select anything. When you're ready, 
                click the button to start the game. Good luck! üéâ</p>
                <br>
                <button id="start">Start The Game!</button>
        </div>
        <div id="menu-content">
            <h1 id="word"></h1>
            <p id="definition">Please wait a second, the game is loading...</p>
            <p><button onclick="speakWord();">Say it again</button>
            <button id="restart">New Word</button></p>
            <button id="SaveScore">Save score to database!</button>
            <div id="bottom">
                <p>Mistakes: <num id="mistakes"></num></p>
                <p>Finished words: <num id="finished"></num></p>
                <p>Letters per second: <num id="lps"></num></p>
            </div>
        </div>
    </div>
    <div id="parental-leaderboard">
        <div id="leaderboard">
            <div id="leaderboard-content">
                <h2>Leaderboard</h2>
                <p><span id="lspam">Username</span><span id="lspam">Mistakes</span><span id="lspam">Finished</span><span id="lspam">LPS</span><p>
                <ol id="leaderboard-list"></ol>
            </div>
        </div>
    </div>
</body>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
  
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD7o35jWsWjL2Ztuv9TK8C8V1duI6h_yoQ",
      authDomain: "puzzlegame-a3cec.firebaseapp.com",
      projectId: "puzzlegame-a3cec",
      storageBucket: "puzzlegame-a3cec.firebasestorage.app",
      messagingSenderId: "397914192255",
      appId: "1:397914192255:web:c88ef2b21590fd0f34c24a"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    signInAnonymously(auth).then(() => {
        // Signed in..
        console.log('Signed in');
    }).catch((error) => {
        var errorCode = error.code;
        var errorMessage = error.message;
        // ...
    });

function DatabaseCall(SaveScoreToDatabase, name, mistakes, finished) {
    onAuthStateChanged(auth, async (user) => {
    if (user) {
        // User is signed in, see docs for a list of available properties
        // https://firebase.google.com/docs/reference/js/firebase.User
        var uid = user.uid;
        console.log('User is signed in');

        // Add a new document with a generated id.
        console.log("IMPORTANT" + SaveScoreToDatabase);
        if (SaveScoreToDatabase == 1) {
            console.log("IMPORTANT" + name.value);
            addDoc(collection(db, "spellingbee"), {
                uid: uid,
                name: name.value,
                mistakes: mistakes,
                finishedWords: finished,
                lettersPerSecond: lps.textContent,
            }).then(() => {
                console.log("Document written with ID: ", uid);
            }).catch((error) => {
                console.error("Error adding document: ", error);
            });
        }

        const usersSnapshot = await getDocs(collection(db, "spellingbee"));
        const leaderboardList = document.getElementById('leaderboard-list');
        leaderboardList.innerHTML = '';

for (const userDoc of usersSnapshot.docs) {
const userDocRef = doc(db, "spellingbee", userDoc.id);
const subcollectionSnapshot = await getDocs(collection(userDocRef, "knownSubcollectionName"));

const userData = userDoc.data();
const userName = userData.name;
const userMistakes = userData.mistakes;
const userFinishedWords = userData.finishedWords;
const userLPS = userData.lettersPerSecond;
const listItem = document.createElement('li');
listItem.innerHTML = `<span id="lspam">${userName}</span><span id="lspam">${userMistakes}</span><span id="lspam">${userFinishedWords}</span><span id="lspam">${userLPS}</span>`;
listItem.setAttribute('data-user-score', userFinishedWords);
await console.log(listItem.getAttribute('data-user-score'));
leaderboardList.appendChild(listItem);
console.log(`User ${userDoc.id} has ${userName} no documents in the subcollection.`);

}
await sortList();

function sortList() {
var list, i, switching, b, shouldSwitch;
list = document.getElementById("leaderboard-list");
switching = true;
/* Make a loop that will continue until
no switching has been done: */
while (switching) {
// start by saying: no switching is done:
switching = false;
b = list.getElementsByTagName("LI");
// Loop through all list-items:
for (i = 0; i < (b.length - 1); i++) {
  // start by saying there should be no switching:
  shouldSwitch = false;
  /* check if the next item should
  switch place with the current item: */
  console.log(b[i].getAttribute('data-user-score'));
  console.log(b[i + 1]);
  if (Number(b[i].getAttribute('data-user-score')) < Number(b[i + 1].getAttribute('data-user-score'))) {
    /* if next item is numerically
    lower than current item, mark as a switch
    and break the loop: */
    shouldSwitch = true;
    break;
  }
}
if (shouldSwitch) {
  /* If a switch has been marked, make the switch
  and mark the switch as done: */
  b[i].parentNode.insertBefore(b[i + 1], b[i]);
  switching = true;
}
}
}

    } else {
        console.log('Firebase had a small error');
    }
})};
window.DatabaseCall = DatabaseCall;
DatabaseCall(0);
</script>
<script>
// Create a grid background
const svg = document.getElementById('back');
for (let a = 0; a < 20; a++) {
    const backline = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    backline.setAttribute("y1", a * 200);
    backline.setAttribute("x1", 0);
    backline.setAttribute("y2", 0);
    backline.setAttribute("x2", a * 200);
    svg.appendChild(backline);
}

let utterance;
let wordJson;
const finishedElement = document.getElementById("finished");
let definitionElement = document.getElementById("definition");
let wordElement = document.getElementById("word");
async function GetWord() {
    try {
        let wordResponse = await fetch("https://random-word-api.herokuapp.com/word?number=1");
        wordJson = await wordResponse.json();
        console.log(wordJson[0]);
        wordElement.innerHTML = wrapWordInSpans(wordJson[0]);
        
        let dictionaryResponse = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${wordJson[0]}`);
        let dictionaryJson = await dictionaryResponse.json();

        let definitions = dictionaryJson[0].meanings[0].definitions.map(def => def.definition);
        definitions.sort((a, b) => b.length - a.length);
        definitionElement.innerHTML = definitions.join('<br>');
        speakWord();
    } catch (error) {
        if (error.message.includes("Cannot read properties of undefined")) {
            GetWord();
        }
    }
}

function wrapWordInSpans(word) {
    return word.split('').map(letter => `<span>${letter}</span>`).join('');
}

const synth = window.speechSynthesis;
function speakWord() {
    synth.cancel();
    const utterance = new SpeechSynthesisUtterance(wordJson[0]);
    utterance.lang = "en-US"; // Set language
    utterance.pitch = 1;      // Set pitch (0 to 2)
    utterance.rate = 1;       // Set rate (0.1 to 10)
    synth.speak(utterance);
}

const restart = document.getElementById("restart");
restart.addEventListener("mousedown", async () => {
    i = 0;
    time = 0;
    small_mistakes = 0;
    definitionElement.innerHTML = "Please wait a second, the game is loading...";
    SaveScore.style.display = "none";
    GetWord();
});

let time = 0;
let clicked = 0;
let small_mistakes = 0;
let i = 0;
let mistakes = 0;
let finished = 0;
window.addEventListener("keydown", function(event) {
        if (time === 0) {
            time = Date.now();
        }
        const timenew = Date.now();
        clicked++
        lps.textContent = `${(clicked / ((timenew - time) / 1000)).toFixed(2)}`;
        const spans = wordElement.querySelectorAll('span');
        if (event.key.toLowerCase() === spans[i].textContent) {
            spans[i].style.opacity = 1;
            small_mistakes = 0;
            i++;
        } else {
            small_mistakes++;
            mistakes++;
            document.getElementById("mistakes").textContent = `${mistakes}`;
            if (small_mistakes > 2) {
                small_mistakes = 0;
                spans[i].style.opacity = 1;
                spans[i].style.color = "red";
                i++;
            }
        }
        console.log(event.key);
        console.log(spans[i]?.textContent);
        if (spans[i]?.textContent === undefined) {
            wordElement.innerHTML = `<h2>You have correctly spelled ${wordJson[0]}!</h2>`;
            finished++;
            finishedElement.textContent = `${finished}`;
            SaveScore.style.display = null;
        }
    });

const start = document.getElementById("start");
start.addEventListener("mousedown", () => {
    document.getElementById("starting-menu-content").style.display = "none";
    document.getElementById("menu-content").style.display = "flex";
    SaveScore.style.display = "none";
    GetWord();
});

const NameElement = document.getElementById("name")
const SaveScore = document.getElementById("SaveScore");
SaveScore.addEventListener("mousedown", async () => {
    if (NameElement.value == "") {
        NameElement.value = "User";
    }       
    await DatabaseCall(1, NameElement, mistakes, finished);
});
</script>
